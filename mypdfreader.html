<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF阅读器 - 云端版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #242424 100%);
        }

        /* 顶部工具栏 */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            background-color: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 100;
            transition: transform 0.3s ease;
            position: relative;
        }

        .toolbar.hidden {
            transform: translateY(-100%);
        }

        /* 工具栏切换按钮 */
        .toggle-toolbar {
            position: fixed;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background-color: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top: none;
            border-radius: 0 0 6px 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 150;
            backdrop-filter: blur(10px);
            font-size: 12px;
            color: #888;
        }

        .toolbar.hidden + .toggle-toolbar {
            top: 0;
        }

        .toggle-toolbar:hover {
            background-color: rgba(40, 40, 40, 0.9);
            color: #e0e0e0;
            height: 28px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: #f0f0f0;
            line-height: 1.2;
        }

        .page-info {
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 1.2;
        }

        .page-info .current-page {
            color: #888;
            transition: color 0.3s ease;
        }

        .page-info .current-page.read {
            color: #ef4444;
            font-weight: 600;
        }

        /* 页码跳转输入 */
        .page-jump {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-jump-input {
            width: 60px;
            padding: 4px 8px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 12px;
            text-align: center;
            outline: none;
        }

        .page-jump-input:focus {
            border-color: rgba(113, 128, 150, 0.5);
        }

        .page-jump-btn {
            padding: 4px 12px;
            background-color: rgba(113, 128, 150, 0.2);
            border: 1px solid rgba(113, 128, 150, 0.3);
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-jump-btn:hover {
            background-color: rgba(113, 128, 150, 0.3);
        }

        /* 页码指示器（新位置：跳转按钮旁边） */
        .page-indicator-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-indicator-toggle {
            padding: 4px 8px;
            background-color: rgba(113, 128, 150, 0.2);
            border: 1px solid rgba(113, 128, 150, 0.3);
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .page-indicator-toggle:hover {
            background-color: rgba(113, 128, 150, 0.3);
        }

        .page-indicator-container {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background-color: rgba(30, 30, 30, 0.95);
            padding: 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
            gap: 3px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            /* 使用 CSS Grid 来创建更好的布局 */
            grid-template-columns: repeat(var(--grid-columns, 10), 1fr);
            width: calc(var(--grid-columns, 10) * 28px + 11 * 3px + 24px);
        }

        .page-indicator-container.show {
            display: grid;
        }

        .page-indicator-container::-webkit-scrollbar {
            width: 4px;
        }

        .page-indicator-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .page-indicator {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.05);
            color: #666;
            position: relative;
        }

        .page-indicator:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .page-indicator.read {
            background-color: rgba(113, 128, 150, 0.3);
            color: #a0c4e0;
            font-weight: 600;
        }

        .page-indicator.read::after {
            content: '✓';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background-color: #4ade80;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #1a1a1a;
        }

        .page-indicator.current {
            background-color: #718096;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 0 0 2px rgba(113, 128, 150, 0.5);
        }

        /* 阅读模式切换 */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: rgba(30, 30, 30, 0.5);
            border-radius: 20px;
        }

        .mode-label {
            font-size: 11px;
            color: #888;
        }

        .mode-switch {
            position: relative;
            width: 36px;
            height: 18px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .mode-switch.active {
            background-color: rgba(239, 68, 68, 0.5);
        }

        .mode-switch-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .mode-switch.active .mode-switch-handle {
            transform: translateX(18px);
        }

        .mode-text {
            font-size: 11px;
            font-weight: 500;
            min-width: 55px;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* 侧边栏目录 */
        .sidebar {
            width: 280px;
            background-color: rgba(24, 24, 24, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }

        .sidebar.hidden {
            margin-left: -280px;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 500;
            color: #f0f0f0;
        }

        .toggle-sidebar {
            position: absolute;
            left: 280px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background-color: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.3s ease;
            z-index: 10;
        }

        .sidebar.hidden + .toggle-sidebar {
            left: 0;
        }

        .toggle-sidebar:hover {
            background-color: rgba(40, 40, 40, 0.9);
        }

        .outline-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .outline-container::-webkit-scrollbar {
            width: 6px;
        }

        .outline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
        }

        .outline-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .outline-item {
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            color: #a0a0a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .outline-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #f0f0f0;
        }

        .outline-item.active {
            background-color: rgba(113, 128, 150, 0.2);
            color: #f0f0f0;
            border-left: 3px solid #718096;
            padding-left: 17px;
        }

        .outline-item.level-1 {
            padding-left: 20px;
        }

        .outline-item.level-2 {
            padding-left: 40px;
            font-size: 12px;
        }

        .outline-item.level-3 {
            padding-left: 60px;
            font-size: 12px;
        }

        .no-outline {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 40px 20px;
        }

        /* 进度显示 */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-bar {
            width: 160px;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a5568 0%, #718096 100%);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .progress-text {
            font-size: 11px;
            color: #a0a0a0;
            min-width: 70px;
            text-align: right;
            line-height: 1.2;
        }

        /* 饼图进度 */
        .pie-progress {
            width: 30px;
            height: 30px;
            position: relative;
        }

        .pie-progress svg {
            transform: rotate(-90deg);
        }

        .pie-background {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 3;
        }

        .pie-fill {
            fill: none;
            stroke: #718096;
            stroke-width: 3;
            transition: stroke-dasharray 0.3s ease;
        }

        /* 按钮样式 */
        .btn {
            padding: 6px 12px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.2;
        }

        .btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
        }

        .btn-mark {
            background-color: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .btn-mark:hover {
            background-color: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .btn-clear {
            background-color: rgba(251, 113, 133, 0.1);
            border-color: rgba(251, 113, 133, 0.2);
            color: #f87171;
        }

        .btn-clear:hover {
            background-color: rgba(251, 113, 133, 0.2);
            border-color: rgba(251, 113, 133, 0.3);
            color: #ef4444;
        }

        .btn-cloud {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .btn-cloud:hover {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .btn-cloud.connected {
            background-color: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .btn-cloud.connected:hover {
            background-color: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        /* 同步状态指示器 */
        .sync-status {
            font-size: 10px;
            color: #666;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .sync-status.error {
            color: #f87171;
            background-color: rgba(239, 68, 68, 0.1);
        }

        .sync-status.success {
            color: #4ade80;
            background-color: rgba(34, 197, 94, 0.1);
        }

        .sync-status.syncing {
            color: #60a5fa;
            background-color: rgba(59, 130, 246, 0.1);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 云端登录表单 */
        .cloud-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cloud-form input {
            width: 100%;
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            outline: none;
        }

        .cloud-form input:focus {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .cloud-form-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cloud-form-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: #888;
            transition: all 0.2s ease;
        }

        .cloud-form-tab.active {
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
        }

        .cloud-settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cloud-settings label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        /* PDF显示区域 */
        .pdf-container {
            flex: 1;
            display: flex;
            justify-content: center;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            background-color: #1a1a1a;
            padding: 20px 0 60px 0;
        }

        .pdf-container::-webkit-scrollbar {
            width: 8px;
        }

        .pdf-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .pdf-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .pdf-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .pdf-canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            background-color: white;
            transition: all 0.3s ease;
            margin: 0 auto;
            height: fit-content;
        }

        .pdf-canvas-wrapper.read-page::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, rgba(113, 128, 150, 0.3) 0%, rgba(74, 85, 104, 0.3) 100%);
            pointer-events: none;
            z-index: 1;
        }

        #pdf-canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* 导航按钮 */
        .nav-buttons {
            position: fixed;
            bottom: 30px;
            right: 40px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: rgba(30, 30, 30, 0.95);
            padding: 16px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .nav-buttons.hidden {
            transform: translateX(calc(100% + 40px));
        }

        /* 导航按钮切换 */
        .toggle-nav {
            position: fixed;
            bottom: 60px;
            right: -2px;
            width: 24px;
            height: 48px;
            background-color: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-right: none;
            border-radius: 6px 0 0 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 150;
            backdrop-filter: blur(10px);
            font-size: 12px;
            color: #888;
        }

        .nav-buttons.hidden + .toggle-nav {
            right: 0;
        }

        .toggle-nav:hover {
            background-color: rgba(40, 40, 40, 0.9);
            color: #e0e0e0;
            width: 28px;
        }

        .nav-button-group {
            display: flex;
            gap: 8px;
        }

        .nav-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            text-align: center;
        }

        /* 文件选择器 */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
        }

        input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        /* 初始化界面 */
        .init-screen {
            position: fixed;
            inset: 0;
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 32px;
            z-index: 1000;
        }

        .init-title {
            font-size: 24px;
            font-weight: 300;
            color: #f0f0f0;
            letter-spacing: 2px;
        }

        .init-subtitle {
            font-size: 14px;
            color: #888;
            margin-top: -20px;
        }

        /* 加载动画 */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #718096;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #242424;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 400;
            color: #f0f0f0;
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 20px;
            outline: none;
        }

        .modal-input:focus {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-note {
            font-size: 12px;
            color: #888;
            margin-bottom: 16px;
        }

        /* 提示信息 */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(30, 30, 30, 0.95);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            color: #e0e0e0;
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 3000;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // 设置PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        class PDFReader {
            constructor() {
                this.currentPDF = null;
                this.currentPage = 1;
                this.totalPages = 0;
                this.readPages = new Set();
                this.pdfDoc = null;
                this.pageRendering = false;
                this.pageNumPending = null;
                this.scale = 1;
                this.canvas = null;
                this.ctx = null;
                this.readingHistory = {};
                this.storagePath = null;
                this.currentFileName = '';
                this.currentFileId = ''; // 新增：文件唯一标识
                this.outline = [];
                this.isElectron = typeof window !== 'undefined' && window.electron;
                this.readingMode = false;
                
                // 云端同步相关
                this.cloudSync = {
                    enabled: false,
                    apiUrl: 'https://my-pdf-blush.vercel.app/api', // 更新为实际的API地址
                    userToken: null,
                    refreshToken: null,
                    syncInterval: 30000, // 30秒自动同步
                    lastSyncTime: 0,
                    isOnline: navigator.onLine,
                    pendingUploads: new Set(),
                    syncTimer: null
                };
                
                this.init();
            }

            init() {
                this.render();
                this.bindEvents();
                this.loadStoragePath();
                this.initCloudSync();
            }

            // ========== 云端同步功能 ==========

            async initCloudSync() {
                // 检查是否有保存的云端配置
                const cloudConfig = localStorage.getItem('pdfCloudConfig');
                if (cloudConfig) {
                    const config = JSON.parse(cloudConfig);
                    this.cloudSync.enabled = config.enabled || false;
                    this.cloudSync.apiUrl = config.apiUrl || this.cloudSync.apiUrl;
                    this.cloudSync.userToken = config.userToken || null;
                    this.cloudSync.refreshToken = config.refreshToken || null;
                }

                // 监听网络状态
                window.addEventListener('online', () => {
                    this.cloudSync.isOnline = true;
                    this.updateSyncStatus('在线');
                    if (this.cloudSync.enabled) {
                        this.syncToCloud();
                    }
                });

                window.addEventListener('offline', () => {
                    this.cloudSync.isOnline = false;
                    this.updateSyncStatus('离线');
                });

                // 启动定期同步
                if (this.cloudSync.enabled && this.cloudSync.userToken) {
                    this.startAutoSync();
                    this.updateSyncStatus('已连接');
                    
                    // 更新UI按钮状态
                    setTimeout(() => {
                        const cloudBtn = document.querySelector('.btn-cloud');
                        if (cloudBtn) {
                            cloudBtn.classList.add('connected');
                            cloudBtn.innerHTML = '云同步<span class="sync-status success">已连接</span>';
                        }
                    }, 100);
                }
            }

            // 生成文件唯一标识
            async generateFileId(file) {
                return file.name ;
            }

            // 云端API调用
            async callCloudAPI(endpoint, method = 'GET', data = null) {
                if (!this.cloudSync.isOnline) {
                    throw new Error('网络不可用');
                }

                const url = `${this.cloudSync.apiUrl}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (this.cloudSync.userToken) {
                    headers['Authorization'] = `Bearer ${this.cloudSync.userToken}`;
                }

                const config = {
                    method,
                    headers,
                };

                if (data && method !== 'GET') {
                    config.body = JSON.stringify(data);
                }

                const response = await fetch(url, config);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `API调用失败: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                // 检查API返回格式
                if (!result.success) {
                    throw new Error(result.message || 'API调用失败');
                }

                return result;
            }

            // 上传阅读记录到云端
            async uploadReadingRecord(fileId, record) {
                try {
                    const result = await this.callCloudAPI('/reading-records', 'POST', {
                        fileId,
                        record: {
                            ...record,
                            fileName: this.currentFileName, // 添加文件名
                            lastModified: new Date().toISOString(),
                            deviceId: this.getDeviceId()
                        }
                    });
                    
                    this.cloudSync.lastSyncTime = Date.now();
                    this.cloudSync.pendingUploads.delete(fileId);
                    return result;
                } catch (error) {
                    console.error('上传阅读记录失败:', error);
                    this.cloudSync.pendingUploads.add(fileId);
                    throw error;
                }
            }

            // 从云端下载阅读记录
            async downloadReadingRecord(fileId) {
                try {
                    const result = await this.callCloudAPI(`/reading-records/${fileId}`);
                    return result.data.record;
                } catch (error) {
                    if (error.message.includes('未找到阅读记录')) {
                        return null; // 云端没有记录
                    }
                    console.error('下载阅读记录失败:', error);
                    throw error;
                }
            }

            // 同步到云端
            async syncToCloud() {
                if (!this.cloudSync.enabled || !this.cloudSync.userToken || !this.currentFileId) {
                    return;
                }

                try {
                    this.updateSyncStatus('同步中...');
                    const record = this.readingHistory[this.currentFileName];
                    if (record) {
                        await this.uploadReadingRecord(this.currentFileId, record);
                        this.updateSyncStatus('同步完成');
                    }
                } catch (error) {
                    this.updateSyncStatus('同步失败');
                    console.error('同步失败:', error);
                }
            }

            // 从云端同步
            async syncFromCloud(fileId) {
                if (!this.cloudSync.enabled || !this.cloudSync.userToken) {
                    return null;
                }

                try {
                    const cloudRecord = await this.downloadReadingRecord(fileId);
                    if (!cloudRecord) {
                        return null;
                    }

                    const localRecord = this.readingHistory[this.currentFileName];
                    
                    // 比较本地和云端记录，选择更新的
                    if (!localRecord || new Date(cloudRecord.lastModified) > new Date(localRecord.lastRead || localRecord.lastModified || 0)) {
                        this.updateSyncStatus('从云端恢复');
                        return cloudRecord;
                    }
                    
                    return localRecord;
                } catch (error) {
                    console.error('从云端同步失败:', error);
                    this.updateSyncStatus('同步失败');
                    return null;
                }
            }

            // 启动自动同步
            startAutoSync() {
                if (this.cloudSync.syncTimer) {
                    clearInterval(this.cloudSync.syncTimer);
                }

                this.cloudSync.syncTimer = setInterval(() => {
                    if (this.cloudSync.enabled && this.currentFileId && this.cloudSync.isOnline) {
                        this.syncToCloud();
                    }
                }, this.cloudSync.syncInterval);
            }

            // 停止自动同步
            stopAutoSync() {
                if (this.cloudSync.syncTimer) {
                    clearInterval(this.cloudSync.syncTimer);
                    this.cloudSync.syncTimer = null;
                }
            }

            // 获取设备ID
            getDeviceId() {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            }

            // 更新同步状态显示
            updateSyncStatus(status) {
                const statusEl = document.querySelector('.sync-status');
                if (statusEl) {
                    statusEl.textContent = status;
                    statusEl.className = 'sync-status';
                    
                    if (status.includes('失败') || status.includes('离线')) {
                        statusEl.classList.add('error');
                    } else if (status.includes('完成') || status.includes('恢复')) {
                        statusEl.classList.add('success');
                    } else if (status.includes('同步中')) {
                        statusEl.classList.add('syncing');
                    }
                }
            }

            // 云端登录
            async cloudLogin(email, password) {
                try {
                    const result = await this.callCloudAPI('/auth/login', 'POST', {
                        email,
                        password
                    });

                    this.cloudSync.userToken = result.data.token;
                    this.cloudSync.refreshToken = result.data.refresh_token;
                    this.cloudSync.enabled = true;
                    
                    // 保存配置
                    const config = {
                        enabled: true,
                        apiUrl: this.cloudSync.apiUrl,
                        userToken: this.cloudSync.userToken,
                        refreshToken: this.cloudSync.refreshToken
                    };
                    localStorage.setItem('pdfCloudConfig', JSON.stringify(config));
                    
                    this.startAutoSync();
                    this.updateSyncStatus('登录成功');
                    this.showToast('云端同步已启用');
                    
                    return true;
                } catch (error) {
                    this.updateSyncStatus('登录失败');
                    this.showToast('登录失败: ' + error.message);
                    return false;
                }
            }

            // 云端注册
            async cloudRegister(email, password, name) {
                try {
                    const result = await this.callCloudAPI('/auth/register', 'POST', {
                        email,
                        password,
                        name
                    });

                    this.showToast('注册成功，请登录');
                    return true;
                } catch (error) {
                    this.showToast('注册失败: ' + error.message);
                    return false;
                }
            }

            // 云端登出
            cloudLogout() {
                this.cloudSync.enabled = false;
                this.cloudSync.userToken = null;
                this.stopAutoSync();
                
                localStorage.removeItem('pdfCloudConfig');
                this.updateSyncStatus('未连接');
                this.showToast('已退出云端同步');
            }

            // ========== 原有功能（修改以支持云端同步） ==========

            bindEvents() {
                // 绑定全局键盘事件
                document.addEventListener('keydown', (e) => {
                    if (!this.pdfDoc) return;
                    
                    if (e.key === 'ArrowLeft') {
                        this.prevPage();
                    } else if (e.key === 'ArrowRight') {
                        // 根据阅读模式决定是否标记
                        if (this.readingMode) {
                            this.nextPageAndMark();
                        } else {
                            this.nextPage();
                        }
                    } else if (e.key === 'Enter' && document.activeElement.id === 'pageJumpInput') {
                        this.jumpToPage();
                    } else if (e.key === 'F11' || (e.key === 'f' && e.ctrlKey)) {
                        // F11 或 Ctrl+F 进入全屏阅读模式
                        e.preventDefault();
                        this.toggleFullscreenReading();
                    } else if (e.key === 'Escape') {
                        // ESC 退出全屏阅读模式
                        this.exitFullscreenReading();
                    } else if (e.key === 't' && e.ctrlKey) {
                        // Ctrl+T 切换工具栏
                        e.preventDefault();
                        this.toggleToolbar();
                    } else if (e.key === 'n' && e.ctrlKey) {
                        // Ctrl+N 切换导航栏
                        e.preventDefault();
                        this.toggleNavButtons();
                    } else if (e.key === 'r' && e.ctrlKey) {
                        // Ctrl+R 清除阅读记录
                        e.preventDefault();
                        this.clearReadingHistory();
                    }
                });

                // 监听窗口大小变化
                window.addEventListener('resize', () => {
                    if (this.pdfDoc) {
                        this.renderPage(this.currentPage);
                    }
                });

                // 点击页面其他地方关闭页码指示器
                document.addEventListener('click', (e) => {
                    const wrapper = document.querySelector('.page-indicator-wrapper');
                    const container = document.querySelector('.page-indicator-container');
                    if (wrapper && !wrapper.contains(e.target)) {
                        container.classList.remove('show');
                    }
                });
            }

            // 计算最优的网格列数，使布局尽可能接近正方形
            calculateOptimalColumns(totalPages) {
                if (totalPages <= 0) return 1;
                
                // 计算理想的正方形边长
                const idealSideLength = Math.sqrt(totalPages);
                
                // 尝试不同的列数，找到最接近正方形的布局
                let bestColumns = Math.floor(idealSideLength);
                let bestRatio = Infinity;
                
                // 在理想值附近尝试几个选项
                for (let cols = Math.max(1, bestColumns - 2); cols <= bestColumns + 3; cols++) {
                    const rows = Math.ceil(totalPages / cols);
                    const ratio = Math.max(rows / cols, cols / rows); // 长宽比
                    
                    if (ratio < bestRatio) {
                        bestRatio = ratio;
                        bestColumns = cols;
                    }
                }
                
                // 限制最小和最大列数
                return Math.max(3, Math.min(15, bestColumns));
            }

            togglePageIndicators() {
                const container = document.querySelector('.page-indicator-container');
                const isShowing = container.classList.contains('show');
                
                if (!isShowing) {
                    // 计算最优列数
                    const optimalColumns = this.calculateOptimalColumns(this.totalPages);
                    
                    // 设置CSS变量
                    container.style.setProperty('--grid-columns', optimalColumns);
                    
                    // 显示容器
                    container.classList.add('show');
                } else {
                    container.classList.remove('show');
                }
                
                this.updateIndicatorToggleText();
            }

            updateIndicatorToggleText() {
                const toggle = document.querySelector('.page-indicator-toggle');
                const container = document.querySelector('.page-indicator-container');
                const isShown = container.classList.contains('show');
                const readCount = this.readPages.size;
                
                toggle.innerHTML = isShown ? 
                    `收起 <span style="font-size: 10px;">▲</span>` : 
                    `已读 ${readCount}/${this.totalPages} <span style="font-size: 10px;">▼</span>`;
            }

            toggleReadingMode() {
                this.readingMode = !this.readingMode;
                const modeSwitch = document.querySelector('.mode-switch');
                const modeText = document.querySelector('.mode-text');
                
                if (this.readingMode) {
                    modeSwitch.classList.add('active');
                    modeText.textContent = '阅读模式';
                    modeText.style.color = '#ef4444';
                } else {
                    modeSwitch.classList.remove('active');
                    modeText.textContent = '浏览模式';
                    modeText.style.color = '#888';
                }
                
                this.showToast(this.readingMode ? '已切换到阅读模式' : '已切换到浏览模式');
            }

            async loadPDF(file) {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                
                try {
                    this.pdfDoc = await loadingTask.promise;
                    this.totalPages = this.pdfDoc.numPages;
                    this.currentFileName = file.name;
                    
                    // 生成文件唯一标识
                    this.currentFileId = await this.generateFileId(file);
                    
                    // 加载目录
                    await this.loadOutline();
                    
                    // 从云端同步阅读历史
                    let cloudRecord = null;
                    if (this.cloudSync.enabled) {
                        this.updateSyncStatus('同步中...');
                        cloudRecord = await this.syncFromCloud(this.currentFileId);
                    }
                    
                    // 加载本地阅读历史
                    await this.loadReadingHistory();
                    
                    // 如果云端有更新的记录，使用云端数据
                    if (cloudRecord) {
                        this.readingHistory[this.currentFileName] = cloudRecord;
                        this.currentPage = cloudRecord.currentPage || 1;
                        this.readPages = new Set(cloudRecord.readPages || []);
                        this.readingMode = cloudRecord.readingMode || false;
                        
                        // 更新阅读模式UI
                        const modeSwitch = document.querySelector('.mode-switch');
                        const modeText = document.querySelector('.mode-text');
                        if (this.readingMode) {
                            modeSwitch.classList.add('active');
                            modeText.textContent = '阅读模式';
                            modeText.style.color = '#ef4444';
                        }
                        
                        this.showToast(`已从云端恢复阅读进度 (第${this.currentPage}页)`);
                    }
                    
                    // 渲染第一页或上次阅读的页面
                    await this.renderPage(this.currentPage);
                    this.updateUI();
                    this.renderPageIndicators();
                    
                    // 启用清除记录按钮
                    const clearBtn = document.querySelector('.btn-clear');
                    if (clearBtn) {
                        clearBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('加载PDF失败:', error);
                    this.showToast('加载PDF失败，请重试');
                }
            }

            async loadOutline() {
                try {
                    const outline = await this.pdfDoc.getOutline();
                    this.outline = [];
                    
                    if (outline) {
                        await this.processOutline(outline, 0);
                    }
                    
                    this.renderOutline();
                } catch (error) {
                    console.error('加载目录失败:', error);
                }
            }

            async processOutline(outline, level) {
                for (const item of outline) {
                    const dest = item.dest;
                    let pageNum = null;
                    
                    if (dest) {
                        try {
                            if (typeof dest === 'string') {
                                const destObj = await this.pdfDoc.getDestination(dest);
                                if (destObj) {
                                    const pageRef = destObj[0];
                                    pageNum = await this.pdfDoc.getPageIndex(pageRef) + 1;
                                }
                            } else if (Array.isArray(dest)) {
                                const pageRef = dest[0];
                                pageNum = await this.pdfDoc.getPageIndex(pageRef) + 1;
                            }
                        } catch (e) {
                            console.error('获取页码失败:', e);
                        }
                    }
                    
                    this.outline.push({
                        title: item.title,
                        page: pageNum,
                        level: level
                    });
                    
                    if (item.items && item.items.length > 0) {
                        await this.processOutline(item.items, level + 1);
                    }
                }
            }

            renderOutline() {
                const container = document.querySelector('.outline-container');
                
                if (this.outline.length === 0) {
                    container.innerHTML = '<div class="no-outline">此PDF没有目录</div>';
                    return;
                }
                
                container.innerHTML = this.outline.map((item, index) => {
                    const levelClass = `level-${Math.min(item.level, 3)}`;
                    const activeClass = item.page === this.currentPage ? 'active' : '';
                    
                    return `
                        <div class="outline-item ${levelClass} ${activeClass}" 
                             data-page="${item.page}" 
                             data-index="${index}"
                             title="${item.title}">
                            ${item.title}
                        </div>
                    `;
                }).join('');
                
                // 绑定点击事件
                container.querySelectorAll('.outline-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const page = parseInt(e.target.dataset.page);
                        if (page) {
                            this.goToPage(page);
                        }
                    });
                });
            }

            renderPageIndicators() {
                const container = document.querySelector('.page-indicator-container');
                if (!this.pdfDoc) return;
                
                let indicators = '';
                for (let i = 1; i <= this.totalPages; i++) {
                    const isRead = this.readPages.has(i);
                    const isCurrent = i === this.currentPage;
                    const classes = `page-indicator ${isRead ? 'read' : ''} ${isCurrent ? 'current' : ''}`;
                    indicators += `<div class="${classes}" data-page="${i}" title="第${i}页">${i}</div>`;
                }
                
                container.innerHTML = indicators;
                
                // 绑定点击事件
                container.querySelectorAll('.page-indicator').forEach(indicator => {
                    indicator.addEventListener('click', (e) => {
                        const page = parseInt(e.target.dataset.page);
                        this.goToPage(page);
                    });
                });
                
                // 更新toggle按钮文字
                this.updateIndicatorToggleText();
            }

            async renderPage(num) {
                if (!this.pdfDoc) return;
                
                this.pageRendering = true;
                
                try {
                    const page = await this.pdfDoc.getPage(num);
                    const viewport = page.getViewport({ scale: 1 });
                    
                    // 计算缩放比例以适应屏幕宽度
                    const containerWidth = document.querySelector('.pdf-container').clientWidth;
                    this.scale = containerWidth / viewport.width;
                    
                    const scaledViewport = page.getViewport({ scale: this.scale });
                    
                    this.canvas.height = scaledViewport.height;
                    this.canvas.width = scaledViewport.width;
                    
                    const renderContext = {
                        canvasContext: this.ctx,
                        viewport: scaledViewport
                    };
                    
                    const renderTask = page.render(renderContext);
                    await renderTask.promise;
                    
                    // 渲染完成后，滚动到顶部
                    document.getElementById('pdfContainer').scrollTop = 0;
                    
                    this.pageRendering = false;
                    
                    if (this.pageNumPending !== null) {
                        this.renderPage(this.pageNumPending);
                        this.pageNumPending = null;
                    }
                } catch (error) {
                    console.error('渲染页面失败:', error);
                    this.pageRendering = false;
                }
            }

            queueRenderPage(num) {
                if (this.pageRendering) {
                    this.pageNumPending = num;
                } else {
                    this.renderPage(num);
                }
            }

            goToPage(pageNum) {
                if (pageNum < 1 || pageNum > this.totalPages) return;
                
                this.currentPage = pageNum;
                
                // 如果跳转到最后一页且在阅读模式，自动标记为已读
                if (this.readingMode && this.currentPage === this.totalPages) {
                    this.readPages.add(this.currentPage);
                    this.saveReadingHistory();
                    this.showToast(`已到达最后一页，自动标记为已读`);
                }
                
                this.queueRenderPage(this.currentPage);
                this.updateUI();
            }

            jumpToPage() {
                const input = document.getElementById('pageJumpInput');
                const pageNum = parseInt(input.value);
                
                if (isNaN(pageNum) || pageNum < 1 || pageNum > this.totalPages) {
                    this.showToast(`请输入1-${this.totalPages}之间的页码`);
                    return;
                }
                
                this.goToPage(pageNum);
                input.blur();
            }

            prevPage() {
                if (this.currentPage <= 1) return;
                this.currentPage--;
                this.queueRenderPage(this.currentPage);
                this.updateUI();
            }

            nextPage() {
                if (this.currentPage >= this.totalPages) return;
                this.currentPage++;
                this.queueRenderPage(this.currentPage);
                this.updateUI();
            }

            prevPageAndMark() {
                if (this.currentPage <= 1) return;
                
                // 如果当前在最后一页，向前翻页时标记最后一页为已读
                if (this.currentPage === this.totalPages) {
                    this.readPages.add(this.currentPage);
                    this.saveReadingHistory();
                    this.showToast(`已标记第 ${this.currentPage} 页为已读`);
                }
                
                this.currentPage--;
                this.queueRenderPage(this.currentPage);
                this.updateUI();
            }

            nextPageAndMark() {
                if (this.currentPage >= this.totalPages) {
                    // 如果已经在最后一页，确保标记为已读
                    if (!this.readPages.has(this.currentPage)) {
                        this.readPages.add(this.currentPage);
                        this.saveReadingHistory();
                        this.showToast(`已标记最后一页为已读`);
                        this.updateUI();
                    }
                    return;
                }
                
                // 标记当前页为已读
                this.readPages.add(this.currentPage);
                this.saveReadingHistory();
                
                this.currentPage++;
                this.queueRenderPage(this.currentPage);
                this.updateUI();
            }

            updateUI() {
                // 更新页面信息（包含已读标记）
                const pageInfoEl = document.querySelector('.page-info');
                const isCurrentPageRead = this.readPages.has(this.currentPage);
                pageInfoEl.innerHTML = `
                    第 <span class="current-page ${isCurrentPageRead ? 'read' : ''}">${this.currentPage}</span> / ${this.totalPages} 页
                    <div class="page-jump">
                        <input type="number" 
                               id="pageJumpInput" 
                               class="page-jump-input" 
                               min="1" 
                               max="${this.totalPages}" 
                               value="${this.currentPage}">
                        <button class="page-jump-btn" onclick="pdfReader.jumpToPage()">跳转</button>
                    </div>
                    <div class="page-indicator-wrapper">
                        <button class="page-indicator-toggle" onclick="pdfReader.togglePageIndicators()">
                            已读 ${this.readPages.size}/${this.totalPages} <span style="font-size: 10px;">▼</span>
                        </button>
                        <div class="page-indicator-container"></div>
                    </div>
                `;
                
                // 重新渲染页码指示器
                this.renderPageIndicators();
                
                // 更新进度
                const progress = (this.readPages.size / this.totalPages) * 100;
                document.querySelector('.progress-fill').style.width = `${progress}%`;
                document.querySelector('.progress-text').textContent = 
                    `已读 ${this.readPages.size} / ${this.totalPages} 页`;
                
                // 更新饼图
                const circumference = 2 * Math.PI * 13;
                const offset = circumference - (progress / 100) * circumference;
                document.querySelector('.pie-fill').style.strokeDasharray = 
                    `${circumference} ${circumference}`;
                document.querySelector('.pie-fill').style.strokeDashoffset = offset;
                
                // 更新页面已读状态
                const wrapper = document.querySelector('.pdf-canvas-wrapper');
                if (this.readPages.has(this.currentPage)) {
                    wrapper.classList.add('read-page');
                } else {
                    wrapper.classList.remove('read-page');
                }
                
                // 更新导航按钮状态
                document.querySelector('.prev-btn').disabled = this.currentPage <= 1;
                document.querySelector('.next-btn').disabled = this.currentPage >= this.totalPages;
                document.querySelector('.prev-mark-btn').disabled = this.currentPage <= 1;
                document.querySelector('.next-mark-btn').disabled = this.currentPage >= this.totalPages;
                
                // 更新清除记录按钮状态
                const clearBtn = document.querySelector('.btn-clear');
                if (clearBtn) {
                    clearBtn.disabled = !this.currentFileName;
                }
                
                // 更新目录高亮
                this.updateOutlineHighlight();
                
                // 更新页码指示器
                this.updatePageIndicators();
            }

            updatePageIndicators() {
                const indicators = document.querySelectorAll('.page-indicator');
                indicators.forEach((indicator, index) => {
                    const pageNum = index + 1;
                    indicator.className = 'page-indicator';
                    
                    if (this.readPages.has(pageNum)) {
                        indicator.classList.add('read');
                    }
                    
                    if (pageNum === this.currentPage) {
                        indicator.classList.add('current');
                    }
                });
                
                // 更新toggle按钮文字
                this.updateIndicatorToggleText();
            }

            updateOutlineHighlight() {
                const items = document.querySelectorAll('.outline-item');
                items.forEach(item => item.classList.remove('active'));
                
                // 找到当前页对应的目录项
                let activeIndex = -1;
                for (let i = this.outline.length - 1; i >= 0; i--) {
                    if (this.outline[i].page && this.outline[i].page <= this.currentPage) {
                        activeIndex = i;
                        break;
                    }
                }
                
                if (activeIndex >= 0) {
                    const activeItem = document.querySelector(`[data-index="${activeIndex}"]`);
                    if (activeItem) {
                        activeItem.classList.add('active');
                        
                        // 滚动到可视区域
                        const container = document.querySelector('.outline-container');
                        const itemTop = activeItem.offsetTop;
                        const itemHeight = activeItem.offsetHeight;
                        const containerHeight = container.offsetHeight;
                        const scrollTop = container.scrollTop;
                        
                        if (itemTop < scrollTop || itemTop + itemHeight > scrollTop + containerHeight) {
                            container.scrollTop = itemTop - containerHeight / 2 + itemHeight / 2;
                        }
                    }
                }
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                sidebar.classList.toggle('hidden');
            }

            toggleToolbar() {
                const toolbar = document.querySelector('.toolbar');
                toolbar.classList.toggle('hidden');
            }

            toggleNavButtons() {
                const navButtons = document.querySelector('.nav-buttons');
                navButtons.classList.toggle('hidden');
            }

            toggleFullscreenReading() {
                const toolbar = document.querySelector('.toolbar');
                const navButtons = document.querySelector('.nav-buttons');
                const sidebar = document.querySelector('.sidebar');
                
                // 如果任一元素可见，则隐藏所有
                const anyVisible = !toolbar.classList.contains('hidden') || 
                                 !navButtons.classList.contains('hidden') || 
                                 !sidebar.classList.contains('hidden');
                
                if (anyVisible) {
                    toolbar.classList.add('hidden');
                    navButtons.classList.add('hidden');
                    sidebar.classList.add('hidden');
                    this.showToast('全屏阅读 (ESC退出, Ctrl+T工具栏, Ctrl+N导航, Ctrl+R清除记录)');
                } else {
                    toolbar.classList.remove('hidden');
                    navButtons.classList.remove('hidden');
                    sidebar.classList.remove('hidden');
                    this.showToast('已退出全屏阅读模式');
                }
            }

            exitFullscreenReading() {
                const toolbar = document.querySelector('.toolbar');
                const navButtons = document.querySelector('.nav-buttons');
                const sidebar = document.querySelector('.sidebar');
                
                toolbar.classList.remove('hidden');
                navButtons.classList.remove('hidden');
                sidebar.classList.remove('hidden');
            }

            async saveReadingHistory() {
                if (!this.currentFileName) return;
                
                this.readingHistory[this.currentFileName] = {
                    currentPage: this.currentPage,
                    readPages: Array.from(this.readPages),
                    totalPages: this.totalPages,
                    lastRead: new Date().toISOString(),
                    readingMode: this.readingMode
                };

                // 保存到本地存储
                if (this.isElectron && window.electron.saveReadingHistory && this.storagePath) {
                    try {
                        await window.electron.saveReadingHistory(this.storagePath, this.readingHistory);
                    } catch (error) {
                        console.error('保存本地阅读历史失败:', error);
                    }
                } else {
                    localStorage.setItem('pdfReadingHistory', JSON.stringify(this.readingHistory));
                }

                // 云端同步
                if (this.cloudSync.enabled && this.currentFileId) {
                    try {
                        await this.uploadReadingRecord(this.currentFileId, this.readingHistory[this.currentFileName]);
                    } catch (error) {
                        // 如果同步失败，标记为待上传
                        this.cloudSync.pendingUploads.add(this.currentFileId);
                        console.error('云端同步失败:', error);
                    }
                }
            }

            async loadReadingHistory() {
                if (this.isElectron && window.electron.loadReadingHistory && this.storagePath) {
                    // Electron环境：从文件系统加载
                    try {
                        this.readingHistory = await window.electron.loadReadingHistory(this.storagePath);
                    } catch (error) {
                        console.error('加载阅读历史失败:', error);
                        this.readingHistory = {};
                    }
                } else {
                    // 浏览器环境：从localStorage加载
                    const history = localStorage.getItem('pdfReadingHistory');
                    if (history) {
                        this.readingHistory = JSON.parse(history);
                    }
                }
                
                if (this.readingHistory[this.currentFileName]) {
                    const fileHistory = this.readingHistory[this.currentFileName];
                    this.currentPage = fileHistory.currentPage || 1;
                    this.readPages = new Set(fileHistory.readPages || []);
                    this.readingMode = fileHistory.readingMode || false;
                    
                    // 更新阅读模式UI
                    const modeSwitch = document.querySelector('.mode-switch');
                    const modeText = document.querySelector('.mode-text');
                    if (this.readingMode) {
                        modeSwitch.classList.add('active');
                        modeText.textContent = '阅读模式';
                        modeText.style.color = '#ef4444';
                    }
                }
            }

            loadStoragePath() {
                this.storagePath = localStorage.getItem('pdfStoragePath');
            }

            async setStoragePath() {
                if (this.isElectron && window.electron.selectFolder) {
                    // Electron环境：使用系统文件选择器
                    try {
                        const folderPath = await window.electron.selectFolder();
                        if (folderPath) {
                            this.storagePath = folderPath;
                            localStorage.setItem('pdfStoragePath', this.storagePath);
                            document.getElementById('storagePathInput').value = folderPath;
                            this.showToast('存储路径已设置: ' + folderPath);
                        }
                    } catch (error) {
                        console.error('选择文件夹失败:', error);
                    }
                } else {
                    // 浏览器环境：显示模态框
                    document.getElementById('storageModal').classList.add('show');
                    const existingPath = localStorage.getItem('pdfStoragePath');
                    if (existingPath) {
                        document.getElementById('storagePathInput').value = existingPath;
                    }
                }
            }

            async selectFolder() {
                if (this.isElectron && window.electron.selectFolder) {
                    try {
                        const folderPath = await window.electron.selectFolder();
                        if (folderPath) {
                            document.getElementById('storagePathInput').value = folderPath;
                        }
                    } catch (error) {
                        console.error('选择文件夹失败:', error);
                    }
                } else {
                    this.showToast('文件夹选择功能需要在Electron环境中使用');
                }
            }

            confirmStoragePath() {
                const path = document.getElementById('storagePathInput').value.trim();
                if (path) {
                    this.storagePath = path;
                    localStorage.setItem('pdfStoragePath', this.storagePath);
                    this.showToast('存储路径已设置: ' + path);
                    this.closeModal();
                } else {
                    this.showToast('请输入有效的存储路径');
                }
            }

            closeModal() {
                document.getElementById('storageModal').classList.remove('show');
            }

            // ========== 云端同步UI控制 ==========

            openCloudModal() {
                const modal = document.getElementById('cloudModal');
                const loginSection = document.getElementById('cloudLoginSection');
                const manageSection = document.getElementById('cloudManageSection');
                const apiUrlInput = document.getElementById('cloudApiUrl');

                // 设置API URL
                apiUrlInput.value = this.cloudSync.apiUrl;

                if (this.cloudSync.enabled && this.cloudSync.userToken) {
                    loginSection.style.display = 'none';
                    manageSection.style.display = 'block';
                } else {
                    loginSection.style.display = 'block';
                    manageSection.style.display = 'none';
                }

                modal.classList.add('show');
            }

            closeCloudModal() {
                document.getElementById('cloudModal').classList.remove('show');
                
                // 保存API URL设置
                const apiUrlInput = document.getElementById('cloudApiUrl');
                if (apiUrlInput.value.trim()) {
                    this.cloudSync.apiUrl = apiUrlInput.value.trim();
                    const config = JSON.parse(localStorage.getItem('pdfCloudConfig') || '{}');
                    config.apiUrl = this.cloudSync.apiUrl;
                    localStorage.setItem('pdfCloudConfig', JSON.stringify(config));
                }
            }

            switchCloudTab(tab) {
                const tabs = document.querySelectorAll('.cloud-form-tab');
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');

                tabs.forEach(t => t.classList.remove('active'));
                
                if (tab === 'login') {
                    tabs[0].classList.add('active');
                    loginForm.style.display = 'flex';
                    registerForm.style.display = 'none';
                } else {
                    tabs[1].classList.add('active');
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'flex';
                }
            }

            async handleCloudLogin() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    this.showToast('请填写邮箱和密码');
                    return;
                }

                const success = await this.cloudLogin(email, password);
                if (success) {
                    this.closeCloudModal();
                    // 更新按钮状态
                    const cloudBtn = document.querySelector('.btn-cloud');
                    cloudBtn.classList.add('connected');
                    cloudBtn.innerHTML = '云同步<span class="sync-status success">已连接</span>';
                }
            }

            async handleCloudRegister() {
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirm = document.getElementById('registerConfirm').value;

                if (!name || !email || !password || !confirm) {
                    this.showToast('请填写所有字段');
                    return;
                }

                if (password !== confirm) {
                    this.showToast('两次输入的密码不一致');
                    return;
                }

                const success = await this.cloudRegister(email, password, name);
                if (success) {
                    this.switchCloudTab('login');
                }
            }

            handleCloudLogout() {
                this.cloudLogout();
                this.closeCloudModal();
                
                // 更新按钮状态
                const cloudBtn = document.querySelector('.btn-cloud');
                cloudBtn.classList.remove('connected');
                cloudBtn.innerHTML = '云同步<span class="sync-status">未连接</span>';
            }

            clearReadingHistory() {
                if (!this.currentFileName) {
                    this.showToast('当前没有打开的PDF文件');
                    return;
                }
                // 显示确认模态框
                document.getElementById('clearModal').classList.add('show');
            }

            closeClearModal() {
                document.getElementById('clearModal').classList.remove('show');
            }

            async confirmClearHistory() {
                if (!this.currentFileName) {
                    this.closeClearModal();
                    return;
                }

                try {
                    // 清除当前文件的阅读记录
                    if (this.readingHistory[this.currentFileName]) {
                        delete this.readingHistory[this.currentFileName];
                    }

                    // 保存更新后的历史记录
                    if (this.isElectron && window.electron.saveReadingHistory && this.storagePath) {
                        await window.electron.saveReadingHistory(this.storagePath, this.readingHistory);
                    } else {
                        localStorage.setItem('pdfReadingHistory', JSON.stringify(this.readingHistory));
                    }

                    // 清除云端记录
                    if (this.cloudSync.enabled && this.currentFileId) {
                        try {
                            await this.callCloudAPI(`/reading-records/${this.currentFileId}`, 'DELETE');
                            this.updateSyncStatus('云端已清除');
                        } catch (error) {
                            console.error('清除云端记录失败:', error);
                            this.updateSyncStatus('云端清除失败');
                        }
                    }

                    // 重置当前状态
                    this.currentPage = 1;
                    this.readPages.clear();
                    this.readingMode = false;

                    // 更新UI
                    this.queueRenderPage(this.currentPage);
                    this.updateUI();
                    this.renderPageIndicators();
                    
                    // 重置阅读模式UI
                    const modeSwitch = document.querySelector('.mode-switch');
                    const modeText = document.querySelector('.mode-text');
                    modeSwitch.classList.remove('active');
                    modeText.textContent = '浏览模式';
                    modeText.style.color = '#888';

                    this.closeClearModal();
                    this.showToast('阅读记录已清除（包括云端）');
                } catch (error) {
                    console.error('清除阅读记录失败:', error);
                    this.showToast('清除阅读记录失败，请重试');
                }
            }

            showToast(message) {
                const toast = document.querySelector('.toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            render() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="app-container">
                        <div class="init-screen" id="initScreen">
                            <h1 class="init-title">PDF 阅读器</h1>
                            <p class="init-subtitle">极简设计，专注阅读，云端同步</p>
                            <div class="file-input-wrapper">
                                <input type="file" id="fileInput" accept=".pdf" 
                                       onchange="pdfReader.handleFileSelect(event)">
                                <label for="fileInput" class="btn">
                                    选择 PDF 文件
                                </label>
                            </div>
                        </div>

                        <div class="toolbar" style="display: none;">
                            <div class="toolbar-left">
                                <div class="file-info">
                                    <div class="file-name">未选择文件</div>
                                    <div class="page-info">第 <span class="current-page">0</span> / 0 页</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="pie-progress">
                                    <svg width="30" height="30">
                                        <circle class="pie-background" cx="15" cy="15" r="13" />
                                        <circle class="pie-fill" cx="15" cy="15" r="13" />
                                    </svg>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <div class="progress-text">已读 0 / 0 页</div>
                            </div>

                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div class="mode-toggle">
                                    <span class="mode-label">模式:</span>
                                    <span class="mode-text" style="color: #888;">浏览模式</span>
                                    <div class="mode-switch" onclick="pdfReader.toggleReadingMode()">
                                        <div class="mode-switch-handle"></div>
                                    </div>
                                </div>
                                <button class="btn btn-cloud" onclick="pdfReader.openCloudModal()" title="云端同步设置">
                                    云同步<span class="sync-status">未连接</span>
                                </button>
                                <button class="btn btn-clear" onclick="pdfReader.clearReadingHistory()" title="清除当前PDF的阅读记录" disabled>
                                    清除记录
                                </button>
                                <div class="file-input-wrapper">
                                    <input type="file" id="fileInput2" accept=".pdf" 
                                           onchange="pdfReader.handleFileSelect(event)">
                                    <label for="fileInput2" class="btn">
                                        打开文件
                                    </label>
                                </div>
                                <button class="btn" onclick="pdfReader.toggleToolbar()" title="隐藏工具栏">
                                    ▲
                                </button>
                            </div>
                        </div>
                        <div class="toggle-toolbar" onclick="pdfReader.toggleToolbar()" title="显示工具栏">
                            ▼
                        </div>

                        <div class="main-content" style="display: none;">
                            <div class="sidebar">
                                <div class="sidebar-header">
                                    <span class="sidebar-title">目录</span>
                                </div>
                                <div class="outline-container"></div>
                            </div>
                            <div class="toggle-sidebar" onclick="pdfReader.toggleSidebar()">
                                <span>‹</span>
                            </div>
                            <div class="pdf-container" id="pdfContainer">
                                <div class="pdf-canvas-wrapper">
                                    <canvas id="pdf-canvas"></canvas>
                                </div>
                                <div class="loading" style="display: none;">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>

                        <div class="nav-buttons" style="display: none;">
                            <div>
                                <div class="nav-label">浏览模式</div>
                                <div class="nav-button-group">
                                    <button class="btn btn-icon prev-btn" onclick="pdfReader.prevPage()" title="上一页（不标记）">
                                        ←
                                    </button>
                                    <button class="btn btn-icon next-btn" onclick="pdfReader.nextPage()" title="下一页（不标记）">
                                        →
                                    </button>
                                </div>
                            </div>
                            <div>
                                <div class="nav-label">阅读模式</div>
                                <div class="nav-button-group">
                                    <button class="btn btn-icon btn-mark prev-mark-btn" onclick="pdfReader.prevPageAndMark()" title="上一页（标记已读）">
                                        ◀
                                    </button>
                                    <button class="btn btn-icon btn-mark next-mark-btn" onclick="pdfReader.nextPageAndMark()" title="下一页（标记已读）">
                                        ▶
                                    </button>
                                </div>
                            </div>
                            <button class="btn" onclick="pdfReader.toggleNavButtons()" title="隐藏导航" style="margin-top: 8px; font-size: 10px; padding: 4px 8px;">
                                ▶
                            </button>
                        </div>
                        <div class="toggle-nav" onclick="pdfReader.toggleNavButtons()" title="显示导航">
                            ◀
                        </div>

                        <div class="toast"></div>
                        
                        <!-- 云端同步模态框 -->
                        <div class="modal" id="cloudModal">
                            <div class="modal-content">
                                <h3 class="modal-title">云端同步设置</h3>
                                
                                <div id="cloudLoginSection">
                                    <div class="cloud-form-tabs">
                                        <div class="cloud-form-tab active" onclick="pdfReader.switchCloudTab('login')">登录</div>
                                        <div class="cloud-form-tab" onclick="pdfReader.switchCloudTab('register')">注册</div>
                                    </div>
                                    
                                    <div class="cloud-form" id="loginForm">
                                        <input type="email" id="loginEmail" placeholder="邮箱地址" required>
                                        <input type="password" id="loginPassword" placeholder="密码" required>
                                        <div class="modal-buttons">
                                            <button class="btn" onclick="pdfReader.closeCloudModal()">取消</button>
                                            <button class="btn btn-cloud" onclick="pdfReader.handleCloudLogin()">登录</button>
                                        </div>
                                    </div>
                                    
                                    <div class="cloud-form" id="registerForm" style="display: none;">
                                        <input type="text" id="registerName" placeholder="姓名" required>
                                        <input type="email" id="registerEmail" placeholder="邮箱地址" required>
                                        <input type="password" id="registerPassword" placeholder="密码" required>
                                        <input type="password" id="registerConfirm" placeholder="确认密码" required>
                                        <div class="modal-buttons">
                                            <button class="btn" onclick="pdfReader.closeCloudModal()">取消</button>
                                            <button class="btn btn-cloud" onclick="pdfReader.handleCloudRegister()">注册</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="cloudManageSection" style="display: none;">
                                    <p style="color: #4ade80; margin-bottom: 20px;">✓ 云端同步已启用</p>
                                    <p style="font-size: 12px; color: #888; margin-bottom: 20px;">
                                        您的阅读记录会自动同步到云端，在任意设备上都能继续阅读。
                                    </p>
                                    <div class="modal-buttons">
                                        <button class="btn" onclick="pdfReader.closeCloudModal()">关闭</button>
                                        <button class="btn btn-clear" onclick="pdfReader.handleCloudLogout()">退出登录</button>
                                    </div>
                                </div>
                                
                                <div class="cloud-settings">
                                    <label for="cloudApiUrl">API服务器地址:</label>
                                    <input type="url" id="cloudApiUrl" class="modal-input" 
                                           placeholder="https://your-project-name.vercel.app/api"
                                           value="https://my-pdf-blush.vercel.app/api">
                                    <p style="font-size: 11px; color: #666; margin-top: 8px;">
                                        使用您自己的Vercel API地址
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 清除阅读记录确认模态框 -->
                        <div class="modal" id="clearModal">
                            <div class="modal-content">
                                <h3 class="modal-title">确认清除阅读记录</h3>
                                <p class="modal-note">此操作将清除当前PDF的所有阅读记录，包括：</p>
                                <ul style="color: #a0a0a0; font-size: 12px; margin: 12px 0 12px 20px; line-height: 1.5;">
                                    <li>已读页面标记</li>
                                    <li>当前阅读位置</li>
                                    <li>阅读模式设置</li>
                                    <li>云端同步记录</li>
                                </ul>
                                <p style="color: #f87171; font-size: 12px; margin-bottom: 20px;">⚠️ 此操作无法撤销</p>
                                <div class="modal-buttons">
                                    <button class="btn" onclick="pdfReader.closeClearModal()">取消</button>
                                    <button class="btn btn-clear" onclick="pdfReader.confirmClearHistory()">确认清除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                this.canvas = document.getElementById('pdf-canvas');
                this.ctx = this.canvas.getContext('2d');
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // 隐藏初始化界面，显示主界面
                document.getElementById('initScreen').style.display = 'none';
                document.querySelector('.toolbar').style.display = 'flex';
                document.querySelector('.main-content').style.display = 'flex';
                document.querySelector('.nav-buttons').style.display = 'flex';
                document.querySelector('.loading').style.display = 'block';
                
                // 确保所有UI元素都是可见状态（移除hidden类）
                document.querySelector('.toolbar').classList.remove('hidden');
                document.querySelector('.nav-buttons').classList.remove('hidden');
                document.querySelector('.sidebar').classList.remove('hidden');
                
                // 更新文件名
                document.querySelector('.file-name').textContent = file.name;
                
                // 重置状态
                this.currentPage = 1;
                this.readPages.clear();
                
                await this.loadPDF(file);
                
                document.querySelector('.loading').style.display = 'none';
            }
        }

        // 创建PDF阅读器实例
        const pdfReader = new PDFReader();
    </script>
</body>
</html>